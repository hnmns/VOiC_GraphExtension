{% extends "base.html" %}


{% block content %}

  {% if current_user.is_authenticated %}
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='main.css') }}">
    <h1>My Documents</h1>
	
    <form id="temp" method="POST" action="">
      {{ form.hidden_tag() }}
      <fieldset class="form-group">
        <div class="input-group rounded">
			<button type="button" class="btn btn-primary mr-2" data-toggle="modal" data-target="#FormModal">
				Fill by Form
			</button>
          {% if form.search_bar.errors %}
            {{ form.search_bar(**{'data-toggle': 'tooltip', 'title': 'Precede your search with graph: to perform a graph search.', 'class': 'form-control rounded mr-2 is-invalid', 'data-placement': 'right'}) }}
            {{ form.submit(class="btn btn-outline-primary mr-2") }}
            <div class="invalid-feedback">
              {% for error in form.search_bar.errors %}
                <span>{{ error }}</span>
              {% endfor %}
            </div>
          {% else %}
            {{ form.search_bar(**{'data-toggle': 'tooltip', 'title': 'Precede your search with graph: to perform a graph search.', 'class': 'form-control rounded mr-2', 'data-placement': 'right'}) }}
            {{ form.submit(class="btn btn-outline-primary mr-2") }}
			<a class="btn btn-outline-primary mr-2" href="{{ url_for('new_document') }}">Create</a>
          {% endif %}
	</form>


</fieldset>

<div class="modal fade" id="FormModal" tabindex="-1" role="dialog" aria-labelledby="FormModalLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">

			<div class="modal-header">
				<h3 class="modal-title" style="text-decoration: none" id="FormModalLabel">Search by Form</h3>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>

			<div class="modal-body">
				<p><small id="headerHelp" class="text-muted">Enter information to automatically generate a search graph.</small></p>
				<h4 class="modal-title" style="text-decoration: none" id="FormLawLabel">Title 20. Domestic Relations</h4>
				
				<form id="TheForm" name="TheForm">
					<!-- <div class="form-group gform-group">
						<h5 class="modal-title" id="childSection">Child</h5>
						<div class="row">
							<div class="col">
								<label for="ex1">Ex1</label>
								<div class="form-check">	
									<input type="radio" class="form-check-input" id="ex1a" name="ex1" onclick="exFunction()" value="0">a
								</div>
								<div class="form-check">
									<input type="radio" class="form-check-input" id="ex1b" name="ex1" onclick="exFunction()" value="1">b
								</div>
							</div>

							<div class="col">
								<label for="ex2">Ex2</label>
								<input class="form-control" id="ex2" name="ex2" placeholder="Ex2">
							</div>
						</div>
					</div> -->


					<div class="form-group gform-group">
						<div class="row">	
							<div class="col">
								<label for="Child">Child</label>
								<input type="Child" class="form-control" id="Child" name="Child" aria-describedby="childHelp" placeholder="Child name">
								<small id="childHelp" class="form-text text-muted">Subject of custody dispute</small>
							</div>
							
							<div class="col">
								<label for="endDate">Current date</label>
								<input id="endDate" name="endDate" type="date" class="form-control" onchange="jurisFunction()">
							</div>
						</div>
					</div>

					<div class="form-group gform-group">
						<div class="row">	
							<div class="col">
								<label for="childState">Child's current state</label>
								<select class="form-control" id="childState" name="childState">
									<option value="0">Select a state</option>
									<option value="1">Florida</option>
									<option value="2">Michigan</option>
									<option value="3">Virginia</option>
								</select>
							</div>
							<div class="col">
								<label for="startDate">Current state arrival date</label>
								<input id="startDate" name="startDate" type="date" class="form-control" onchange="jurisFunction()">
								<small id="startDateHelp" class="form-text text-muted">Date of child's arrival to current state</small>
							</div>
						</div>
					</div>

					<div class="form-group gform-group">
						<div class="row">
							<div class="col">
								<label for="childPrevState">Child's previous state</label>
								<select class="form-control" id="childPrevState" name="childPrevState">
									<option value="0">Select a state</option>
									<option value="1">Florida</option>
									<option value="2">Michigan</option>
									<option value="3">Virginia</option>
								</select>
							</div>
							<div class="col">
								<label for="startPrevDate">Previous state arrival date</label>
								<input id="startPrevDate" name="startPrevDate" type="date" class="form-control" onchange="jurisFunction()">
								<small id="startPrevDateHelp" class="form-text text-muted">Date of child's arrival to previous state</small>
							</div>
						</div>
					</div>

					<div class="form-group gform-group">
						<div class="row">
							<div class="col">
								<label for="ex3">Exclusive, continuing jurisdiction valid in:</label>
								<input disabled class="form-control disabled" id="ex3" name="ex3">
							</div>
						</div>
					</div>


					<div class="form-group gform-group border-top">
						<h5 class="modal-title" id="parent1Section">Parent 1</h5>
						<div class="row">	
							<div class="col">
								<label for="Parent1">Name</label>
								<input type="parent1" class="form-control" id="Parent1" name="Parent1" placeholder="Claimant">
							</div>
							<div class="col">
								<label for="parent1Status">Status</label>
								<select class="form-control" id="parent1Status" name="parent1Status">
									<option value="0">N/A</option>
									<option value="1">Claimant</option>
									<option value="2">Respondent</option>
								</select>
							</div>
						</div>
						<div class="row">
							<div class="col">
								<label class="lab" for="parent1State">State</label>
								<select class="form-control" id="parent1State" name="parent1State" onchange="jurisFunction()">
									<option value="0">Select a state</option>
									<option value="1">Florida</option>
									<option value="2">Michigan</option>
									<option value="3">Virginia</option>
								</select>
							</div>
							<div class="col">
								<label class="lab" for="parent1Jurisdiction">Case 1's claimed jurisdiction</label>
								<select class="form-control" id="parent1Jurisdiction" name="parent1Jurisdiction">
									<option value="0">Select a jurisdiction</option>
									<option value="1">Home state</option>
									<option value="2">Exclusive, continuing</option>
								</select>
								<small id="parent1JurisdictionHelp" class="form-text text-muted">Jurisdiction for parent 1's case</small>
							</div>
						</div>
						<div class="row">
							<div class="col">

								<label class="form-check-label" for="checks">Case 1 retains jurisdiction?</label>
								<div class="form-check">
									<input id="checkParent1" name="checkParent" class="form-check-input" type="radio" value="1"> Jurisdiction retained
								</div>
							</div>
						</div>
					</div>

					<div class="form-group gform-group border-top">
						<h5 class="modal-title" id="parent2Section">Parent 2</h5>
						<div class="row">	
							<div class="col">
								<label for="Parent2">Name</label>
								<input type="parent2" class="form-control" id="Parent2" name="Parent2" placeholder="Respondent">
							</div>
							<div class="col">
								<label for="parent2Status">Status</label>
								<select class="form-control" id="parent2Status" name="parent2Status">
									<option value="0">N/A</option>
									<option value="1">Claimant</option>
									<option value="2">Respondent</option>
								</select>
							</div>
						</div>
					
						<div class="row">
							<div class="col">
								<label class="lab" for="parent2State">State</label>
								<select class="form-control" id="parent2State" name="parent2State">
									<option value="">Select a state</option>
									<option value="1">Florida</option>
									<option value="2">Michigan</option>
									<option value="3">Virginia</option>
								</select>
							</div>
							<div class="col">
								<label class="lab" for="parent2Jurisdiction">Case 2's claimed jurisdiction</label>
								<select class="form-control" id="parent2Jurisdiction" name="parent2Jurisdiction">
									<option value="0">Select a jurisdiction</option>
									<option value="1">Home state</option>
									<option value="2">Exclusive, continuing</option>
								</select>
								<small id="parent2JurisdictionHelp" class="form-text text-muted">Jurisdiction for parent 2's case</small>
							</div>
						</div>

						<div class="row">
							<div class="col">
								<label class="form-check-label" for="checkParent2">Case 2 retains jurisdiction?</label>
								<div class="form-check">
									<input id="checkParent2" name="checkParent" class="form-check-input" type="radio" value="2"> Jurisdiction retained
								</div>
							</div>
						</div>
					</div>

					<div class="form-group gform-group border-top">
						<div class="row">	
							<div class="col">
								<label class="form-check-label" for="checkParentNA">No jurisdiction retained</label>
								<div class="form-check">
									<input id="checkParentNA" name="checkParent" class="form-check-input" type="radio" value="0" checked> N/A
								</div>
							</div>
						</div>
					</div>


					</div>
						<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
						<button type="button" id="auto_string_btn" class="btn btn-primary">Submit</button>
						</div>
					</div>

				</form>

			</div>
		</div>
	</div>
</div>

    {% for document in documents.items %}
      <article class="media content-section document-images">
        <div class="media-body">
          <div class="article-metadata">
            <small class="text-muted">
              <b>Updated:</b> {{ document.updated_at.strftime('%Y-%m-%d %H:%M') }}

              {% if request.MOBILE %}
                <br>
              {% endif %}

              <b>Users:</b>
              {% if document.user|length > 0 %}
                {% for user in document.user %}
                  {{ user.username }}
                {% endfor %}
              {% else %}
                <i>None</i>
              {% endif %}

              {% if request.MOBILE %}
                <br>
              {% endif %}

              <b>Roles:</b>
              {% if document.role|length > 0 %}
                {% for role in document.role %}
                  {{ role.title }}
                {% endfor %}
              {% else %}
                <i>None</i>
              {% endif %}
            </small>

            {% if request.MOBILE %}
              <br>
              <a class="btn btn-outline-primary mt-1 mr-1 btn-sm" href="{{ url_for('view_document', document_id=document.id) }}">View</a>
              <a class="btn btn-outline-primary mt-1 mr-1 btn-sm" href="{{ url_for('edit_document', document_id=document.id) }}">Edit</a>
              <a class="btn btn-outline-primary mt-1 mr-1 btn-sm" href="{{ url_for('duplicate_document', document_id=document.id) }}">Copy</a>
              <a class="btn btn-outline-danger mt-1 btn-sm" href="{{ url_for('delete_document', document_id=document.id) }}">Delete</a>
            {% else %}
              <a class="btn btn-outline-danger btn-sm float-right" href="{{ url_for('delete_document', document_id=document.id) }}">Delete</a>
              <a class="btn btn-outline-primary mr-2 btn-sm float-right" href="{{ url_for('duplicate_document', document_id=document.id) }}">Copy</a>
              <a class="btn btn-outline-primary mr-2 btn-sm float-right" href="{{ url_for('edit_document', document_id=document.id) }}">Edit</a>
              <a class="btn btn-outline-primary mr-2 btn-sm float-right" href="{{ url_for('view_document', document_id=document.id) }}">View</a>
            {% endif %}
          </div>

          <div class="text-break text-wrap">
            <h3>{{ document.title }}</h3>
          </div>

          {% if document.content|length > 1000 %}
            <p class="article-content">{{ document.content[:1000] | safe }}... <a class="" href="{{ url_for('view_document', document_id=document.id) }}">Read More</a></p>
          {% else %}
            <p class="article-content limit-img-size">{{ document.content | safe }}</p>
          {% endif %}
        </div>
      </article>
    {% endfor %}
    <div class="d-flex justify-content-center">
      {% for page_num in documents.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
        {% if page_num %}
          {% if documents.page == page_num %}
            <a class="btn btn-primary mb-4 mr-2" href="{{ url_for('home', page=page_num) }}">{{ page_num }}</a>
          {% else %}
            <a class="btn btn-outline-primary mb-4 mr-2" href="{{ url_for('home', page=page_num) }}">{{ page_num }}</a>
          {% endif %}
        {% else %}
        {% endif %}
      {% endfor %}
    </div>
  {% else %}
    <h1>Welcome to VOiC</h1>
    <p>
      While almost all of the documents we write, read, share, act on, process or archive are digital, their management remains archaic. This is particularly true in the case of most office and government systems. In business and government, documents chronicle and immortalize the evolution of thoughts, deliberations, laws and decisions for the for the past as historical records, the present and the future. While the traditional paper-based hard copies serve as reliable preservation medium, they are vulnerable to theft, destruction and loss.
    </p>
    <p>
      <img src="{{ url_for('static', filename='img/devices-medium.png') }}" alt="desktop" class="float-left mr-2">
      On the other hand, digital documents are prone to cybercrimes of various kinds, but less prone to destruction due to aging, fading or loss. With proper safeguards in place, they are largely indestructible. Yet, a robust office document management system is mostly absent. In this project, we develop a new web-based document processing and management system called <u><i>V</i></u>irtual <u><i>O</i></u>ffice in the <u><i>C</i></u>loud}, or <i>VOiC</i> (pronounced voice), to create, share, query and update office documents. In VOiC, we make provisions to support decision workflows, virtual office and provenance and privacy based on role-based authorization. The system is based upon a recently proposed model for document management in virtual offices.
    </p>
    <a class="btn btn-outline-primary mb-5 btn-lg d-flex justify-content-center" href="{{ url_for('sign_up') }}">Try It Now</a>
  {% endif %}


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/jquery.validation/1.16.0/jquery.validate.min.js"></script>
<script>
	jQuery.validator.setDefaults({
		debug: true,
		success: "valid"
	});

	

	jQuery.validator.addMethod("lessThan",  // Checking valid start/end dates
		function(value, element, params) {
			// console.log($(params).val().length);
			if($(params).val().length==0){
				return true;
			}
			if (!/Invalid|NaN/.test(new Date(value))) {
				return new Date(value) < new Date($(params).val());
			}

			return isNaN(value) && isNaN($(params).val()) 
				|| (Number(value) < Number($(params).val())); 
		},
		'Must be before current date.' // Error message
	);

	jQuery.validator.addMethod("parentJurisdictionEntered", 
		function(value, element, params) {
			if ($('input[name=checkParent]:checked', "#TheForm").val()==0){ // N/As
				// console.log("OK, N/A");
				return true;
			}
			else if ($('input[name=checkParent]:checked', "#TheForm").val()==1){ // Parent 1's jurisdiction chosen
				if ($(params[0]).val().length!=0 && $(params[1]).val()!=0 && $(params[2]).val()!=0){
					return true;
				} else {
					return false;
				}
			}
			else if ($('input[name=checkParent]:checked', "#TheForm").val()==2){ // Parent 2's jurisdiction chosen
				if ($(params[3]).val().length!=0 && $(params[4]).val()!=0 && $(params[5]).val()!=0){
					return true;
				} else {
					return false;
				}
			}
		},
		'Select N/A if missing parent, their state of residence, and/or their claimed jurisdiction.'
	);


	var gform1 = $( "#TheForm" );

	function exFunction() {
        // if ($("#ex1a").checked) {alert("dink")}
		// console.log($('#ex1a').val());
		$('input:radio[name="ex1"]').change(
			function(){
				if (this.checked && this.value == '0') {
					// console.log(this.value);
					$('#ex2').val(this.value);
					$('#ex2').css({'color':'red'});
				} else if (this.checked && this.value == '1'){
					// console.log(this.value);
					$('#ex2').val(this.value);
					$('#ex2').css({'color':'green'});
				}
			}
		);
	}

	function jurisFunction() {
        
		var start = $('#startDate').val();
		var startPrev = $('#startPrevDate').val();
		var end = $('#endDate').val();
		const Start = new Date(start);
		const StartPrev = new Date(startPrev);
		const End = new Date(end);
		var Diff = new Date(End - Start);
		var DiffPrev = new Date(Start - StartPrev);
		var months = Diff.getMonth();
		var monthsPrev = DiffPrev.getMonth();
		var monthDiff = End.getMonth() - Start.getMonth() + (12 * (End.getFullYear() - Start.getFullYear()));
		var monthPrevDiff = Start.getMonth() - StartPrev.getMonth() + (12 * (Start.getFullYear() - StartPrev.getFullYear()));
		// console.log(monthDiff);
		if (monthDiff >= 6){
			$('#ex3').val("Exclusive, continuing in " + $("#childState :selected").text());
			$('#ex3').css({'color':'green'});
		} else if (monthPrevDiff >= 6){
			$('#ex3').val("Exclusive, continuing in " + $("#childPrevState :selected").text());
			$('#ex3').css({'color':'green'});
		} else {
			$('#ex3').val("No valid exclusive, continuing cases.");
			$('#ex3').css({'color':'grey'});
		}
	}

	gform1.validate({
		rules:{
			Child: 'required',
			childState: 'required',
			startDate: {
				required: function(element) {
					return $("#endDate").val().length!=0;
				},
				lessThan: "#endDate"
			},
			endDate: {
				required: function(element) {
					return $("#startDate").val().length!=0;
				}
			},
			Parent1: {
				required: function(element) {
					return $("#parent1State").val().length!=0;
				}
			},
			checkParent: {
				parentJurisdictionEntered: ["#Parent1","#parent1State","#parent1Jurisdiction","#Parent2","#parent2State","#parent2Jurisdiction"]
			}
		}
	});


	function formatVEV(v1, e, v2, v1type="val", v2type="val") {
		if (v1type=="text"){
			V1 = $(v1).text();
		} else {V1 = $(v1).val();}
		if (v2type=="text"){
			V2 = $(v2).text();
		} else {V2 = $(v2).val();}

		return "," + V1 + "-" + e + "-" + V2;
	}

	$('#auto_string_btn').click(function(){
		if (gform1.valid()){
			const residency_req_dict = {
				"Florida" : 183,
				"Michigan" : 183,
				"Virginia" : 183,
				"Idaho" : 270,
				"Hawaii" : 200,
				// Add a wildcard default of 183 days??
			};

			var start = $('#startDate').val();
			var startPrev = $('#startPrevDate').val();
			var end = $('#endDate').val();
			const Start = new Date(start);
			const StartPrev = new Date(startPrev);
			const End = new Date(end);
			// end - start returns difference in milliseconds 
			var Diff = new Date(End - Start);
			var DiffPrev = new Date(Start - StartPrev);
			// console.log(Date(Diff));
			var Days = Diff/1000/60/60/24;
			var DaysPrev = DiffPrev/1000/60/60/24;
			// console.log(Diff.getMonth());

			////////////////////////////
			// Put the graph together //
			////////////////////////////
			var prep_string = "graph:"; // Build graph search string from here

			prep_string = prep_string + $('#Child').val() + "-LivesIn-" + $('#childState :selected').text();

			if (Days >= residency_req_dict[$('#childState :selected').text()]) {
				// prep_string = prep_string + "," + $('#childState :selected').text() + "-IsResidenceOf-" + $('#Child').val();
				prep_string = prep_string + formatVEV('#Child', "IsResidentOf", '#childState :selected', v1type="val", v2type="text");
			} else if (DaysPrev >= residency_req_dict[$('#childPrevState :selected').text()]) {
				prep_string = prep_string + formatVEV('#Child', "IsResidentOf", '#childPrevState :selected', v1type="val", v2type="text");
			}
			

			// Parents
			juris_dict = {1:"HasHomeState", 2:"HasExclusiveContinuing"};
			if ($('#Parent1').val().length!=0){
				prep_string = prep_string + formatVEV('#Parent1', "IsParentOf", '#Child');
				
				if ($('#parent1State').val()!=0){
					prep_string = prep_string + formatVEV('#Parent1', "IsFrom", '#parent1State option:selected', v1type="val", v2type="text");
					if ($('#parent1Jurisdiction :selected').val()!=0){
						var jurisdiction1 = juris_dict[$('#parent1Jurisdiction :selected').val()];
						prep_string = prep_string + formatVEV('#Parent1', jurisdiction1, '#Child', v1type="val", v2type="val");
						console.log($('input[name=checkParent]:checked', '#TheForm').val());
						if ($('input[name=checkParent]:checked', '#TheForm').val()=="1"){
							prep_string = prep_string + formatVEV('#Parent1', "RetainsJurisdictionOver", '#Child', v1type="val", v2type="val");
						}
					}
				}
				if ($('#parent1Status :selected').val()==1){
					prep_string = prep_string + formatVEV('#Parent1', "IsClaimantOf", '#Child');
				} else if ($('#parent1Status :selected').val()==2){
					prep_string = prep_string + formatVEV('#Parent1', "IsRespondentOf", '#Child');
				}
			}

			if ($('#Parent2').val().length!=0){
				prep_string = prep_string + formatVEV('#Parent2', "IsParentOf", '#Child');

				if ($('#parent2State').val()!=0){
					prep_string = prep_string + formatVEV('#Parent2', "IsFrom", '#parent2State :selected', v1type="val", v2type="text");
					if ($('#parent2Jurisdiction :selected').val()!=0){
						var jurisdiction2 = juris_dict[$('#parent2Jurisdiction :selected').val()];
						prep_string = prep_string + formatVEV('#Parent2', jurisdiction2, '#Child', v1type="val", v2type="val");
						if ($('input[name=checkParent]:checked', '#TheForm').val()=="2"){
							prep_string = prep_string + formatVEV('#Parent2', "RetainsJurisdictionOver", '#Child', v1type="val", v2type="val");
						}
					}
				}
				if ($('#parent2Status :selected').val()==1){
					prep_string = prep_string + formatVEV('#Parent2', "IsClaimantOf", '#Child');
				} else if ($('#parent2Status :selected').val()==2){
					prep_string = prep_string + formatVEV('#Parent2', "IsRespondentOf", '#Child');
				}
			}

			const checkP = $('input[name=checkParent]:checked').val(); // Which parent retains jurisdiction?
			if (checkP=="1" && $('#parent2Jurisdiction').val() == "2"){
				prep_string = prep_string + formatVEV('#parent2State :selected',"DeferredTo",'#parent1State :selected', v1type="text", v2type="text");
			} else if (checkP=="2" && $('#parent1Jurisdiction').val() == "2"){
				prep_string = prep_string + formatVEV('#parent1State :selected',"DeferredTo",'#parent2State :selected', v1type="text", v2type="text");
			}

			////////////////////////////////////
			// Submit/paste to the search bar //
			////////////////////////////////////
			$('#FormModal').modal('hide');
			// $('#search_bar').val(prep_string.toLowerCase());
			$('#search_bar').val(prep_string); // Do not want edges put to lowercase...

		}
		else{
			// Does anything even need to go here???
		}
	});

</script>

{% endblock %}
